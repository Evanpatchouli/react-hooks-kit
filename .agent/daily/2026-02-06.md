# 2026-02-06 工作日志

## 完成的工作

### 1. 优化 useFavicon Hook
- **优化 `favicon.ts` 工具函数**
  - 移除了接口和函数中的多余空行
  - 将 fontSize 默认值从 16 改为 32（更符合 favicon 标准尺寸）
  - 添加了 canvas context 的错误处理
  - 移除了不专业的注释（表情符号和分隔线）

- **优化 `useFavicon.ts` 主 Hook**
  - 添加了角标（badge）功能支持
  - 修复了 crossOrigin 问题（移除 `img.crossOrigin = "anonymous"` 避免同域图片 CORS 错误）
  - 实现了 TypeScript 函数重载（3个重载签名）
  - 添加了完整的 JSDoc 注释（遵循项目标准）
  - 支持 99+ 显示（数字超过99自动显示为"99+"）
  - 使用 useMemo 稳定依赖，避免重复渲染

- **创建示例组件**
  - example.1 - 动态计数器角标
  - example.2 - 通知消息角标
  - example.3 - 在线状态指示器
  - example.4 - 不同位置演示
  - example.5 - 99+ 大数字显示
  - example.6 - 文本 Favicon（用户添加）
  - 所有示例都使用 MUI 组件（Button, Select, MenuItem, FormControl）
  - 使用 Tab 组件包装避免 favicon 冲突

- **更新文档**
  - 更新了 `locale.en.tsx` 中的所有文案（desc, detail, $p1, consideration, $best, $faqs, $apis）
  - 更新了 `useFavicon.api.tsx` API 文档（完整的参数和返回值说明）

### 2. 完善 useTitle Hook 文档
- **创建示例组件**
  - example.1 - 基础用法（设置和外部修改检测）
  - example.2 - 动态计数器（实时更新标题）
  - example.3 - 通知消息（未读消息计数）
  - example.4 - 定时器（每秒更新）
  - example.5 - 页面状态（状态指示器）
  - 所有示例都使用 MUI 组件
  - 使用 Tab 组件包装避免 title 冲突

- **更新文档页面**
  - 更新了 `UseTitle.tsx`，添加 Tab 组件包装
  - 导入并展示所有5个示例

- **更新文档内容**
  - 更新了 `locale.en.tsx` 中的所有文案
  - desc - 简短描述
  - detail - 详细说明（MutationObserver、自动恢复）
  - $p1 - 用法说明
  - consideration - 4条注意事项
  - $best - 6条最佳实践
  - $faqs - 5个常见问题
  - $apis - 完整参数和返回值说明
  - API 文档（useTitle.api.tsx）已完整

## 遇到的问题和解决方案

### 1. crossOrigin 导致图片加载失败
**问题**：设置 `img.crossOrigin = "anonymous"` 导致同域图片加载失败，报错 "Failed to load icon: /favicon.ico"

**原因**：对于同域的图片，设置 crossOrigin 会触发 CORS 检查，如果服务器没有返回正确的 CORS 头，浏览器会拒绝加载图片到 canvas 中

**解决方案**：移除 `img.crossOrigin = "anonymous"` 这行代码，对于同域图片不需要设置 crossOrigin

### 2. TypeScript 函数重载实现不正确
**问题**：最初只是修改了函数签名添加联合类型，没有正确实现 TypeScript 函数重载

**解决方案**：添加正确的重载签名：
```typescript
function useFavicon(iconUrl: string): void;
function useFavicon(iconUrl: string, badge: string | number): void;
function useFavicon(iconUrl: string, options: UseFaviconOptions): void;
export default function useFavicon(iconUrl: string, options?: UseFaviconOptions | string | number): void {
  // 实现
}
```

### 3. 多个示例同时修改 favicon 导致冲突
**问题**：5个示例都在修改 favicon，如果同时显示会互相冲突

**解决方案**：使用 MUI 的 Tab 组件包装所有示例，一次只显示一个示例

### 4. locale 文件编辑时字符串匹配问题
**问题**：使用 Edit 工具时，由于有多个相同的字符串（如 `$p1: ""`），replace_all 为 false 时无法唯一标识

**解决方案**：提供更多上下文，包含前面的特定内容来唯一标识要替换的位置

## 项目当前状态

- **当前版本**: 1.2.2
- **Git 状态**: 有未提交的修改
  - 新增文件：useFavicon 和 useTitle 的示例组件
  - 修改文件：useFavicon.ts, favicon.ts, UseTitle.tsx, UseFavicon.tsx, locale.en.tsx, API 文档等

- **已完成的 Hook 文档**:
  - useFavicon - 完整文档（6个示例，完整文案，API 文档）
  - useTitle - 完整文档（5个示例，完整文案，API 文档）

## 待办事项

- 提交今天的修改到 Git
- 考虑为其他 hook 也添加充足的示例和完整文档
- 测试 useFavicon 和 useTitle 在不同浏览器中的兼容性

## 技术要点

### useFavicon 实现要点
1. 使用 canvas 绘制角标
2. 支持动态图标尺寸（使用 img.naturalWidth）
3. 相对 padding（iconSize * 0.06）
4. 99+ 支持（超过99显示"99+"）
5. 删除所有旧 icon 元素避免缓存

### useTitle 实现要点
1. 使用 MutationObserver 监控外部修改
2. 组件卸载时自动恢复原始 title
3. 使用 useRef 保存原始 title
4. 使用 isInternalUpdate 标记区分内部和外部修改

## 备注

- 所有示例都使用了 MUI 组件，保持界面统一
- 使用 Tab 组件包装示例是一个很好的模式，可以应用到其他 hook 的文档中
- JSDoc 注释遵循项目标准（参考 useMeta），包含完整的 Parameters, Return, Usage, Example, FAQs
