# 2026-02-06 工作日志

## 完成的工作

### 1. 优化 useFavicon Hook
- **优化 `favicon.ts` 工具函数**
  - 移除了接口和函数中的多余空行
  - 将 fontSize 默认值从 16 改为 32（更符合 favicon 标准尺寸）
  - 添加了 canvas context 的错误处理
  - 移除了不专业的注释（表情符号和分隔线）

- **优化 `useFavicon.ts` 主 Hook**
  - 添加了角标（badge）功能支持
  - 修复了 crossOrigin 问题（移除 `img.crossOrigin = "anonymous"` 避免同域图片 CORS 错误）
  - 实现了 TypeScript 函数重载（3个重载签名）
  - 添加了完整的 JSDoc 注释（遵循项目标准）
  - 支持 99+ 显示（数字超过99自动显示为"99+"）
  - 使用 useMemo 稳定依赖，避免重复渲染

- **创建示例组件**
  - example.1 - 动态计数器角标
  - example.2 - 通知消息角标
  - example.3 - 在线状态指示器
  - example.4 - 不同位置演示
  - example.5 - 99+ 大数字显示
  - example.6 - 文本 Favicon（用户添加）
  - 所有示例都使用 MUI 组件（Button, Select, MenuItem, FormControl）
  - 使用 Tab 组件包装避免 favicon 冲突

- **更新文档**
  - 更新了 `locale.en.tsx` 中的所有文案（desc, detail, $p1, consideration, $best, $faqs, $apis）
  - 更新了 `useFavicon.api.tsx` API 文档（完整的参数和返回值说明）

### 2. 完善 useTitle Hook 文档
- **创建示例组件**
  - example.1 - 基础用法（设置和外部修改检测）
  - example.2 - 动态计数器（实时更新标题）
  - example.3 - 通知消息（未读消息计数）
  - example.4 - 定时器（每秒更新）
  - example.5 - 页面状态（状态指示器）
  - 所有示例都使用 MUI 组件
  - 使用 Tab 组件包装避免 title 冲突

- **更新文档页面**
  - 更新了 `UseTitle.tsx`，添加 Tab 组件包装
  - 导入并展示所有5个示例

- **更新文档内容**
  - 更新了 `locale.en.tsx` 中的所有文案
  - desc - 简短描述
  - detail - 详细说明（MutationObserver、自动恢复）
  - $p1 - 用法说明
  - consideration - 4条注意事项
  - $best - 6条最佳实践
  - $faqs - 5个常见问题
  - $apis - 完整参数和返回值说明
  - API 文档（useTitle.api.tsx）已完整

### 3. CRA 迁移到 Vite
- **迁移 emotion 配置**
  - 更新 `vite.config.ts`：添加 `jsxImportSource: "@emotion/react"` 和 babel 插件
  - 更新 `tsconfig.json`：添加 `jsxImportSource: "@emotion/react"`
  - 别名配置已迁移完成

### 4. 同步 hooks 导出和文档
- **补充缺失的 hooks 导出**
  - `index.ts` 添加：useReflect, useDimensions
  - `docs.map.tsx` 添加：useAsyncEffect + 11个 other hooks

- **生成组件和文档**
  - 为 12 个 hooks 执行 `locale:add:hook` 和 `view:add:hook` 脚本
  - 生成的组件已移动到对应目录（lifecycle-hooks, other）
  - hooks: useAsyncEffect, useClickAway, useCookie, useDimensions, useHover, useKeyPress, useMousePosition, useOverflow, useRaf, useRafState, useSafeArea, useScroll

### 5. 测试框架迁移（CRA → Vitest）
- **安装依赖**
  - 安装 vitest, @vitest/ui, jsdom

- **配置 Vitest**
  - 更新 `vite.config.ts`：添加 test 配置（globals, environment, setupFiles, css）
  - 更新 `tsconfig.json`：添加 vitest types
  - 更新 `package.json`：添加 test 脚本（test, test:ui, test:run）

- **修复兼容性问题**
  - 在 `setupTests.ts` 添加 jest 兼容性映射：`(globalThis as any).jest = vi;`
  - 修复 useMap 实现中的参数判断逻辑错误

- **测试结果**
  - 所有 272 个测试通过（从 13 个失败到 0 个失败）

### 6. 规范化 useMap Hook
- **添加完整 JSDoc 注释**
  - 遵循项目标准（参考 useMeta）
  - 包含：描述、参数、返回值、用法、示例、FAQs
  - 详细说明了 4 个 set 方法重载

- **完善测试**
  - 创建 `useMap.test.tsx`，包含 19 个测试用例
  - 覆盖：初始化、所有 set 重载、get、del、add 方法、边界情况

- **修复实现问题**
  - 修复 set 方法参数判断逻辑（正确区分函数/对象/基本类型）

### 7. 规范化 useReactor Hook
- **添加完整 JSDoc 注释**
  - 详细描述 Reactor 特性（reactive, proxy, cloneable, resettable, etc.）
  - 完整的参数和返回值文档
  - 详细说明所有 Reactor 实例方法（value, subscribe, get, set, setValue, dispatch, emit, on, clone, reset, toJSON）
  - 包含用法示例和 FAQs

### 8. 完善文档内容
- **useMap 文档**
  - 补充 `locale.en.tsx` 中的空缺内容：
    - desc: 简短描述
    - detail: 详细说明（Map 管理、readonly 特性）
    - $p1: 基础用法说明
    - $faqs: 3 个常见问题（为什么用 useMap、rehydrate vs override、能否直接用 map.set）

- **useReactor 文档**
  - 补充 `locale.en.tsx` 中的内容：
    - consideration: 补充 5 条注意事项（直接修改不触发渲染、path-based 访问、适用场景、插件执行、事件总线隔离）
    - $best: 补充 6 条最佳实践（组件通信、插件系统、path访问、状态订阅、默认值、状态克隆）
    - $faqs: 从 1 个问答扩展到 3 个问答（为什么用 useReactor、何时使用 plugins、能否在组件外使用）

## 遇到的问题和解决方案

### 1. crossOrigin 导致图片加载失败
**问题**：设置 `img.crossOrigin = "anonymous"` 导致同域图片加载失败，报错 "Failed to load icon: /favicon.ico"

**原因**：对于同域的图片，设置 crossOrigin 会触发 CORS 检查，如果服务器没有返回正确的 CORS 头，浏览器会拒绝加载图片到 canvas 中

**解决方案**：移除 `img.crossOrigin = "anonymous"` 这行代码，对于同域图片不需要设置 crossOrigin

### 2. TypeScript 函数重载实现不正确
**问题**：最初只是修改了函数签名添加联合类型，没有正确实现 TypeScript 函数重载

**解决方案**：添加正确的重载签名：
```typescript
function useFavicon(iconUrl: string): void;
function useFavicon(iconUrl: string, badge: string | number): void;
function useFavicon(iconUrl: string, options: UseFaviconOptions): void;
export default function useFavicon(iconUrl: string, options?: UseFaviconOptions | string | number): void {
  // 实现
}
```

### 3. 多个示例同时修改 favicon 导致冲突
**问题**：5个示例都在修改 favicon，如果同时显示会互相冲突

**解决方案**：使用 MUI 的 Tab 组件包装所有示例，一次只显示一个示例

### 4. locale 文件编辑时字符串匹配问题
**问题**：使用 Edit 工具时，由于有多个相同的字符串（如 `$p1: ""`），replace_all 为 false 时无法唯一标识

**解决方案**：提供更多上下文，包含前面的特定内容来唯一标识要替换的位置

### 5. useMap set 方法参数判断逻辑错误
**问题**：`set("key", "value")` 被错误地匹配为 record 模式，导致测试失败

**原因**：原始逻辑检查 `args.length === 1 || (args.length === 2 && typeof args[1] === 'string')`，这会将字符串值误判为 record 模式

**解决方案**：改进判断逻辑，按顺序检查：
1. 第一个参数是函数 → map action 模式
2. 第一个参数是对象（非 null）→ record 模式
3. 参数长度为 2 → key-value 模式（再判断第二个参数是否为函数）

### 6. Vitest 中 jest is not defined
**问题**：从 CRA 迁移到 Vite 后，测试中使用 `jest.fn()` 报错 "jest is not defined"

**原因**：Vitest 使用 `vi` 而不是 `jest` 作为全局对象，但项目中的测试代码使用了 `jest.fn()`

**解决方案**：在 `setupTests.ts` 中添加兼容性映射：
```typescript
import { vi } from 'vitest';
(globalThis as any).jest = vi;
```
这样可以保持测试代码不变，同时兼容 Vitest

## 项目当前状态

- **当前版本**: 1.2.2
- **Git 状态**: 有未提交的修改
  - 新增文件：useFavicon 和 useTitle 的示例组件
  - 修改文件：useFavicon.ts, favicon.ts, UseTitle.tsx, UseFavicon.tsx, locale.en.tsx, API 文档等

- **已完成的 Hook 文档**:
  - useFavicon - 完整文档（6个示例，完整文案，API 文档）
  - useTitle - 完整文档（5个示例，完整文案，API 文档）
  - useMap - 完整文档（4个示例，完整文案，完整 JSDoc，19个测试用例）
  - useReactor - 完整文档（7个示例，完整文案，完整 JSDoc）

## 待办事项

- 提交今天的修改到 Git
- 考虑为其他 hook 也添加充足的示例和完整文档
- 测试 useFavicon 和 useTitle 在不同浏览器中的兼容性

## 技术要点

### useFavicon 实现要点
1. 使用 canvas 绘制角标
2. 支持动态图标尺寸（使用 img.naturalWidth）
3. 相对 padding（iconSize * 0.06）
4. 99+ 支持（超过99显示"99+"）
5. 删除所有旧 icon 元素避免缓存

### useTitle 实现要点
1. 使用 MutationObserver 监控外部修改
2. 组件卸载时自动恢复原始 title
3. 使用 useRef 保存原始 title
4. 使用 isInternalUpdate 标记区分内部和外部修改

## 备注

- 所有示例都使用了 MUI 组件，保持界面统一
- 使用 Tab 组件包装示例是一个很好的模式，可以应用到其他 hook 的文档中
- JSDoc 注释遵循项目标准（参考 useMeta），包含完整的 Parameters, Return, Usage, Example, FAQs
